衡量 Web 页面性能的一个重要指标 **FP（First Paint）**，指从页面加载到首次开始绘制的时长。影响 FP 指标的一个重要因素是网络加载速度。

理解网络的关键是要对网络协议有深刻的认识，HTTP 和 WebSocket 都是基于 TCP/IP 的。需要重点学习在 Web 世界中的 TCP/IP 是如何工作的。

## 一个数据包的旅程

从**数据包如何送达主机**，**主机如何将数据包转交给应用**和**数据是如何被完整地送达应用程序**这三个角度来为讲述数据的传输过程。互联网中的数据是通过数据包来传输的。如果发送的数据很大，那么该数据就会被拆分为很多小数据包来传输。

## IP：把数据包送达目的主机

数据包要在互联网上进行传输，就要符合**网际协议**（Internet Protocol，简称 IP）标准。**计算机的地址就称为 IP 地址，访问任何网站实际上是一台计算机向另外一台计算机请求信息。**

---

把一个数据包从主机 A 发送给主机 B，在传输之前数据包上会被附加上主机 B 的 IP 地址信息，在传输过程中才能正确寻址。还会附加上主机 A 本身的 IP 地址，主机 B 才可以回复信息给主机 A。这些附加的信息会被装进一个叫 IP 头的数据结构里。IP 头是 IP 数据包开头的信息，包含 IP 版本、源 IP 地址、目标 IP 地址、生存时间等信息。

![](https://blog-1252173264.cos.ap-shanghai.myqcloud.com/1679892974786-34b403cf-0a5d-4de2-bd0c-76bfe270fd73.png)

## UDP：把数据包送达应用程序

**用户数据包协议**（User Datagram Protocol），简称 UDP，最重要的信息是端口号，是一个数字，每个想访问网络的程序都需要绑定一个端口号。通过端口号 UDP 把指定的数据包发送给指定的程序。端口号会被装进 UDP 头里面，UDP 头再和原始数据包合并组成新的 UDP 数据包。UDP 头中除了目的端口，还有源端口号等信息。

![](https://blog-1252173264.cos.ap-shanghai.myqcloud.com/1679893157299-de91615d-be1a-42e4-8349-bbe50fb438df.png)

UDP 发送数据时，有各种因素会导致数据包出错，虽然 UDP 可以校验数据是否正确，但是对于错误的数据包 UDP 并不提供重发机制，只是丢弃当前的包，而且 UDP 在发送之后也无法知道是否能达到目的地。但是传输速度却非常快，会应用在一些关注速度、但不那么严格要求数据完整性的领域，如在线视频、互动游戏等。

## TCP：把数据完整地送达应用程序

要求数据传输可靠性（reliability）的应用使用 UDP 传输存在两个问题：

- 数据包在传输过程中容易丢失；
- 大文件被拆分成小数据包来传输，数据包经过不同的路由，并在不同的时间到达接收端，UDP 协议不知道如何组装这些数据包，从而把这些数据包还原成完整的文件。

**TCP（Transmission Control Protocol，传输控制协议）**是一种面向连接的、可靠的、基于字节流的传输层通信协议：

- 提供重传机制，解决数据包丢失问题；
- 引入数据包排序机制，保证把乱序的数据包组合成一个完整的文件。

![](https://blog-1252173264.cos.ap-shanghai.myqcloud.com/1679917851362-07edf853-056a-4ba0-958d-6aa428d3b8b9.png)

完整的 TCP 连接生命周期包括了**建立连接，传输数据**和**断开连接**三个阶段，保证重传机制和数据包的排序功能：

![](https://blog-1252173264.cos.ap-shanghai.myqcloud.com/1679917987925-29ecc738-e884-4586-bc39-ddd70a0fbe86.png)

- 建立连接阶段，通过三次握手来建立客户端和服务器之间的连接。三次握手是指在建立一个 TCP 连接时，客户端和服务器总共要发送三个数据包以确认连接的建立。
- 传输数据阶段，接收端需要对每个数据包进行确认操作，接收端在接收到数据包之后，需要发送确认数据包给发送端。当发送端发送了一个数据包之后，在规定时间内没有接收到接收端反馈的确认消息，则判断为数据包丢失，并触发发送端的重发机制。一个大的文件在传输过程中会被拆分成很多小的数据包，这些数据包到达接收端后，接收端会按照 TCP 头中的序号为其排序，从而保证组成完整的数据。
- 断开连接阶段，数据传输完毕之后，就要终止连接了，通过四次挥手来保证双方都能断开连接。

---
